/********************************************************************************
	File			: direct_io.c
	Description		: example of direct io

*********************************************************************************/
#define _GNU_SOURCE
#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <fcntl.h>

/*
==================================================================================

	Prototype Statement

==================================================================================
*/

/*
==================================================================================

	DEFINES

==================================================================================
*/

/*
==================================================================================

	Management

==================================================================================
*/
static char write_strings[ ] = "direct io example";

/*
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	< Open Functions >

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/
/*
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
	Function	:main
	Input		:int argc
				 < number of arguments >
				 char *argv[ ]
				 < arguments >
	Output		:void
	Return		:int
				 < result >

	Description	:direct io
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
*/
int main( int argc, char *argv[ ] )
{
	int			err;

	char		*pathname;
	int			fd;
	long		align;
	char		*buf	= NULL;
	struct stat	stat_buf;
	size_t		block_size;

	if( argc < 2 )
	{
		fprintf( stderr, "./%s pathname\n", argv[ 0 ] );
		return( -1 );
	}

	/* ------------------------------------------------------------------------ */
	/* open a file with O_DIRECT flag											*/
	/* ------------------------------------------------------------------------ */
	pathname = argv[ 1 ];

	fd = open( pathname, O_CREAT | O_RDWR | O_DIRECT, 0664 );

	if( fd < 0 )
	{
		perror( "open : " );
		return( fd );
	}

	/* ------------------------------------------------------------------------ */
	/* get block size of the filesystem											*/
	/* ------------------------------------------------------------------------ */
	err = fstat( fd, &stat_buf );

	if( err < 0 )
	{
		perror( "fstat : " );
		goto err_close;
	}

	block_size = ( size_t )stat_buf.st_blksize;

	/* ------------------------------------------------------------------------ */
	/* get alignment restriction												*/
	/* ------------------------------------------------------------------------ */
	align = fpathconf( fd, _PC_REC_XFER_ALIGN );

	if( align < 0 )
	{
		fprintf( stderr, "error : fpathconf : %ld\n", align );
		goto err_close;
	}

	/* ------------------------------------------------------------------------ */
	/* allocate aligned memory													*/
	/* ------------------------------------------------------------------------ */
	err = posix_memalign( ( void** )&buf, ( size_t )align, block_size );

	if( err < 0 )
	{
		perror( "posix_memalign : " );
		goto err_close;
	}

	/* ------------------------------------------------------------------------ */
	/* write via direct io														*/
	/* ------------------------------------------------------------------------ */
	memset( buf, '\0', block_size );
	memcpy( buf, write_strings, sizeof( write_strings ) );

	err = write( fd, buf, block_size );

	if( err < 0 )
	{
		perror( "write : " );
	}

	/* ------------------------------------------------------------------------ */
	/* free memory																*/
	/* ------------------------------------------------------------------------ */
err_write:
	free( buf );

	/* ------------------------------------------------------------------------ */
	/* close a file																*/
	/* ------------------------------------------------------------------------ */
err_close:
	if( ( err = close( fd ) ) < 0 )
	{
		perror( "close : " );
	}

	return( err );
}

/*
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
	Function	:void
	Input		:void
	Output		:void
	Return		:void

	Description	:void
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
*/

/*
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	< Local Functions >

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/
/*
==================================================================================
	Function	:void
	Input		:void
	Output		:void
	Return		:void

	Description	:void
==================================================================================
*/
